name: Docker Build

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-backend:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build backend image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: false
          tags: mob-backend:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-frontend:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: false
          tags: mob-frontend:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

  docker-compose:
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend]

    steps:
      - uses: actions/checkout@v4

      - name: Create SSL certificates
        run: |
          mkdir -p nginx/ssl
          openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
            -keyout nginx/ssl/privkey.pem \
            -out nginx/ssl/fullchain.pem \
            -subj "/CN=localhost"

      - name: Create JWT keys
        run: |
          mkdir -p backend/config/jwt
          openssl genpkey -algorithm RSA -out backend/config/jwt/private.pem -pkeyopt rsa_keygen_bits:4096
          openssl rsa -pubout -in backend/config/jwt/private.pem -out backend/config/jwt/public.pem

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: pdo, pdo_pgsql, intl, zip

      - name: Create backend .env file
        run: |
          cat > backend/.env << 'EOF'
          APP_ENV=dev
          APP_DEBUG=1
          APP_SECRET=docker_ci_secret
          JWT_SECRET_KEY=%kernel.project_dir%/config/jwt/private.pem
          JWT_PUBLIC_KEY=%kernel.project_dir%/config/jwt/public.pem
          JWT_PASSPHRASE=test_passphrase
          API_USER_PASSWORD=test_password
          DATABASE_URL=postgresql://app:secret@db:5432/trainrouting?serverVersion=16
          CORS_ALLOW_ORIGIN='^https?://localhost(:[0-9]+)?$'
          EOF

      - name: Install backend dependencies
        run: composer install --prefer-dist --no-progress
        working-directory: backend

      - name: Build and start services
        run: docker compose up -d --build

      - name: Wait for database
        run: |
          echo "Waiting for database to be ready..."
          for i in {1..30}; do
            if docker compose exec -T db pg_isready -U app -d trainrouting; then
              echo "Database is ready"
              break
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done

      - name: Create database schema
        run: docker compose exec -T backend php bin/console doctrine:schema:create --env=dev

      - name: Wait for services
        run: |
          echo "Waiting for services to be ready..."
          for i in {1..60}; do
            if docker compose ps | grep -q "healthy"; then
              echo "Services are healthy"
              break
            fi
            echo "Waiting... ($i/60)"
            sleep 2
          done
          docker compose ps
          docker compose logs --tail=50

      - name: Health check backend
        run: |
          for i in {1..10}; do
            if curl -sk https://localhost/api/v1/stations; then
              echo "Health check passed"
              exit 0
            fi
            echo "Retry $i/10..."
            sleep 5
          done
          echo "Health check failed"
          docker compose logs
          exit 1

      - name: Stop services
        run: docker compose down
